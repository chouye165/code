<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Âú£ËØûÊ†ë</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000000;
      font-family: 'Times New Roman', serif;
    }
    #canvas-container {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: clamp(20px, 5vw, 40px);
      box-sizing: border-box;
    }
    .ui-hidden {
      opacity: 0;
      pointer-events: none !important;
    }
    #loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.8s ease-out;
    }
    .loader-text {
      color: #faf6e9;
      font-size: clamp(12px, 3vw, 14px);
      letter-spacing: 4px;
      margin-top: 20px;
      text-transform: uppercase;
      font-weight: 100;
    }
    .spinner {
      width: clamp(30px, 8vw, 40px);
      height: clamp(30px, 8vw, 40px);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-top: 1px solid #faf6e9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    h1 {
      color: #fceea7;
      font-size: clamp(28px, 8vw, 56px);
      margin: 0;
      font-weight: 400;
      letter-spacing: clamp(3px, 1vw, 6px);
      text-shadow: 0 0 50px rgba(252, 238, 167, 0.6);
      background: linear-gradient(to bottom, #fff, #e3e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: fantasy;
      opacity: 0.9;
      transition: opacity 0.5s ease;
      position: relative;
      z-index: 11;
    }
    .upload-wrapper {
      position: absolute;
      top: clamp(15px, 4vw, 40px);
      right: clamp(15px, 4vw, 40px);
      pointer-events: auto;
      text-align: center;
      transition: opacity 0.5s ease;
      z-index: 12;
    }
    .upload-btn {
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgb(255 255 255 / 40%);
      color: #faf6e9;
      padding: clamp(8px, 2vw, 10px) clamp(15px, 4vw, 25px);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: clamp(8px, 2vw, 10px);
      transition: all 0.4s;
      display: inline-block;
      backdrop-filter: blur(5px);
    }
    .upload-btn:hover {
      background: #faf6e9;
      color: #000;
      box-shadow: 0 0 20px rgb(255 255 255 / 40%);
    }
    .hint-text {
      color: rgb(255 255 255 / 40%);
      font-size: clamp(7px, 1.8vw, 9px);
      margin-top: 8px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    #file-input {
      display: none;
    }
    #help-panel {
      position: absolute;
      top: clamp(10px, 3vw, 20px);
      left: clamp(10px, 3vw, 20px);
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid rgb(255 255 255 / 40%);
      border-radius: 8px;
      padding: clamp(12px, 3vw, 20px);
      max-width: clamp(200px, 30vw, 280px);
      pointer-events: auto;
      font-size: clamp(11px, 2.5vw, 13px);
      line-height: 1.6;
      transition: opacity 0.5s ease;
      z-index: 12;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
    }
    #help-panel h3 {
      color: #faf6e9;
      margin: 0 0 15px 0;
      border-bottom: 1px solid #faf6e9;
      padding-bottom: 10px;
      font-size: clamp(14px, 3vw, 16px);
    }
    #help-panel p {
      margin: 8px 0;
      color: #ccc;
    }
    #help-panel code {
      background: rgba(212, 175, 55, 0.15);
      padding: 2px 6px;
      border-radius: 3px;
      color: #faf6e9;
      font-family: monospace;
    }
    #help-panel hr {
      border: none;
      border-top: 1px solid #faf6e9;
      margin: 12px 0;
    }
    .ui-hidden #help-panel,
    .ui-hidden .upload-wrapper {
      opacity: 0;
      pointer-events: none;
    }
    #manage-photos-btn {
      position: absolute;
      bottom: clamp(15px, 4vw, 40px);
      left: clamp(15px, 4vw, 40px);
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgb(255 255 255 / 40%);
      color: #faf6e9;
      padding: clamp(8px, 2vw, 10px) clamp(15px, 4vw, 25px);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: clamp(8px, 2vw, 10px);
      transition: all 0.4s;
      display: inline-block;
      backdrop-filter: blur(5px);
      pointer-events: auto;
      z-index: 12;
    }
    #manage-photos-btn:hover {
      background: #faf6e9;
      color: #000;
      box-shadow: 0 0 20px rgb(255 255 255 / 40%);
    }
    #photo-manager {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      pointer-events: auto;
      padding: clamp(20px, 5vw, 40px) clamp(10px, 3vw, 20px);
      box-sizing: border-box;
      overflow-y: auto;
    }
    #photo-manager.hidden {
      display: none;
    }
    #manager-header {
      color: #faf6e9;
      font-size: clamp(18px, 4vw, 24px);
      margin-bottom: clamp(20px, 4vw, 30px);
      text-align: center;
      font-family: 'Cinzel', 'Times New Roman', serif;
    }
    #photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(100px, 40vw, 150px), 1fr));
      gap: clamp(10px, 3vw, 20px);
      max-width: 700px;
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: clamp(10px, 3vw, 20px);
      box-sizing: border-box;
    }
    .photo-item {
      position: relative;
      width: 100%;
      height: clamp(100px, 40vw, 150px);
      border: 2px solid #faf6e9;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .photo-item img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }
    .delete-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 24px;
      height: 24px;
      background: #cc0000;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      border: 2px solid #000;
      z-index: 1001;
    }
    #close-manager {
      margin-top: clamp(20px, 4vw, 30px);
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgb(255 255 255 / 40%);
      color: #faf6e9;
      padding: clamp(8px, 2vw, 10px) clamp(15px, 4vw, 25px);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: clamp(8px, 2vw, 10px);
      transition: all 0.4s;
      display: inline-block;
      backdrop-filter: blur(5px);
      margin-bottom: clamp(20px, 5vw, 40px);
    }
    #close-manager:hover {
      background: #faf6e9;
      color: #000;
      box-shadow: 0 0 20px rgb(255 255 255 / 40%);
    }
    .control-buttons {
      position: absolute;
      bottom: clamp(15px, 4vw, 40px);
      right: clamp(15px, 4vw, 40px);
      display: flex;
      gap: clamp(8px, 2vw, 15px);
      pointer-events: auto;
      flex-wrap: wrap;
      justify-content: flex-end;
      z-index: 12;
    }
    .control-btn {
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgb(255 255 255 / 40%);
      color: #faf6e9;
      padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 20px);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: clamp(8px, 2vw, 10px);
      transition: all 0.4s;
      backdrop-filter: blur(5px);
      white-space: nowrap;
    }
    .control-btn:hover {
      background: #faf6e9;
      color: #000;
      box-shadow: 0 0 20px rgb(255 255 255 / 40%);
    }

    /* ÁßªÂä®Á´ØÁâπÊÆäÈÄÇÈÖç */
    @media (max-width: 768px) {
      #help-panel {
        max-width: clamp(180px, 40vw, 250px);
        top: auto;
        bottom: 120px;
        left: clamp(15px, 4vw, 20px);
        transition: opacity 0.5s ease;
      }
      .control-buttons {
        gap: 10px;
        bottom: 20px;
        right: clamp(15px, 4vw, 20px);
      }
      #manage-photos-btn {
        bottom: 80px;
        left: clamp(15px, 4vw, 20px);
        transform: none;
        width: auto;
      }
      #photo-grid {
        max-height: 60vh;
      }
      .upload-wrapper {
        top: clamp(15px, 4vw, 40px);
        right: clamp(15px, 4vw, 40px);
        bottom: auto;
      }
    }

    @media (max-width: 480px) {
      #help-panel {
        max-width: 70vw;
        font-size: 11px;
        padding: 12px;
        bottom: 150px;
      }
      .control-buttons {
        flex-direction: column;
        gap: 8px;
        bottom: 20px;
        right: 15px;
      }
      .control-btn {
        width: 100%;
        text-align: center;
      }
      #photo-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      #manage-photos-btn {
        bottom: 120px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <div class="loader-text">Ê≠£Âú®Âä†ËΩΩÂì¶ÔºÅ</div>
  </div>

  <div id="canvas-container"></div>

  <div id="ui-layer">
    <div id="help-panel">
      <h3>üéÑ ÊéßÂà∂ËØ¥Êòé</h3>
      <p><code>T</code> ÈîÆ / ÁÇπÂáªÊåâÈíÆÔºöÁ≤íÂ≠êËÅöÂêà‰∏∫Ê†ëÂΩ¢</p>
      <p><code>S</code> ÈîÆ / ÁÇπÂáªÊåâÈíÆÔºöÁ≤íÂ≠êÊï£ÂºÄ</p>
      <p><code>F</code> ÈîÆ / ÁÇπÂáªÊåâÈíÆÔºöÁÖßÁâáËÅöÁÑ¶</p>
      <p><code>H</code> ÈîÆÔºöÈöêËóèUI</p>
      <p>
        Âú£ËØûÂø´‰πêÔºÅ<code>üíñ</code> 
        <img src="https://tc.666688.dpdns.org/api/cfile/AgACAgUAAyEGAATbbe0rAAMFaUgQ2arOzDbxF2ebF4j78Mf_jJIAAhoOaxvOdEBWPatonyy-y1gBAAMCAAN4AAM2BA" alt="1.jpg" style="width: clamp(30px, 10vw, 50px); height: clamp(30px, 10vw, 50px); border-radius: 50%; vertical-align: middle; margin-right: 8px;" ><b>Â∞èÁò¶Èáë</b>
      </p>
      <hr />
      <p style="font-size: clamp(9px, 2vw, 11px); color: #999; margin-top: 12px">
        üí° ÊîØÊåÅ‰∏ä‰º†Ëá™ÂÆö‰πâÁÖßÁâá
      </p>
    </div>

    <h1>Merry Christmas</h1>

    <div class="upload-wrapper">
      <label class="upload-btn">
        ‰∏ä‰º†ÁÖßÁâá
        <input type="file" id="file-input" multiple accept="image/*" />
      </label>
    </div>
    
    <button id="manage-photos-btn" class="manage-photos-btn">
      È¢ÑËßà
    </button>

    <div class="control-buttons">
      <button class="control-btn" id="tree-btn">Ê†ëÂΩ¢ (T)</button>
      <button class="control-btn" id="scatter-btn">Êï£ÂºÄ (S)</button>
      <button class="control-btn" id="focus-btn">ËÅöÁÑ¶ (F)</button>
    </div>
  </div>

  <div id="photo-manager" class="hidden">
    <h2 id="manager-header">È¢ÑËßà</h2>
    <div id="photo-grid"></div>
    <button id="close-manager">ÂÖ≥Èó≠</button>
  </div>

  <script type="module">
    import * as THREE from 'three'
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js'
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js'
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js'
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js'
    import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js'

    // --- ÈÖçÁΩÆÈ°π ---
    const CONFIG = {
      colors: {
        bg: 0x000000,
        champagneGold: 0xe0e0e0,
        deepGreen: 0xe83c8d,
        accentRed: 0x990000,
      },
      particles: {
        count: 1500,
        dustCount: 2500,
        treeHeight: 24,
        treeRadius: 8,
      },
      camera: {
        z: 50,
      }
    }

    const STATE = {
      mode: 'TREE',
      focusIndex: -1,
      focusTarget: null,
      rotation: { x: 0, y: 0 },
      isDragging: false,
      lastMouseX: 0,
      lastMouseY: 0
    }

    let scene, camera, renderer, composer, controls
    let mainGroup
    let clock = new THREE.Clock()
    let particleSystem = []
    let photoMeshGroup = new THREE.Group()
    let caneTexture

    // ÂàùÂßãÂåñThree.js
    async function init() {
      initThree()
      setupEnvironment()
      setupLights()
      createTextures()
      createParticles()
      createDust()
      createDefaultPhotos()
      setupPostProcessing()
      setupEvents()

      // ÈöêËóèÂä†ËΩΩÂô®
      const loader = document.getElementById('loader')
      loader.style.opacity = 0
      setTimeout(() => loader.remove(), 800)
      
      animate()
    }

    function initThree() {
      const container = document.getElementById('canvas-container')
      scene = new THREE.Scene()
      scene.background = new THREE.Color(CONFIG.colors.bg)
      scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.01)

      camera = new THREE.PerspectiveCamera(
        42,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      )
      camera.position.set(0, 2, CONFIG.camera.z)

      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: false,
        powerPreference: 'high-performance',
      })
      renderer.setSize(window.innerWidth, window.innerHeight)
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
      renderer.toneMapping = THREE.ReinhardToneMapping
      renderer.toneMappingExposure = 2.2
      container.appendChild(renderer.domElement)

      mainGroup = new THREE.Group()
      scene.add(mainGroup)

      // Èº†Ê†áÊéßÂà∂ÊóãËΩ¨
      controls = new OrbitControls(camera, renderer.domElement)
      controls.enableDamping = true
      controls.dampingFactor = 0.05
      controls.rotateSpeed = 0.5
      controls.enableZoom = false
      controls.enablePan = false
    }

    function setupEnvironment() {
      const pmremGenerator = new THREE.PMREMGenerator(renderer)
      scene.environment = pmremGenerator.fromScene(
        new RoomEnvironment(),
        0.04
      ).texture
    }

    function setupLights() {
      const ambient = new THREE.AmbientLight(0xffffff, 0.6)
      scene.add(ambient)

      const innerLight = new THREE.PointLight(0xffaa00, 2, 20)
      innerLight.position.set(0, 5, 0)
      mainGroup.add(innerLight)

      const spotGold = new THREE.SpotLight(0xffcc66, 1200)
      spotGold.position.set(30, 40, 40)
      spotGold.angle = 0.5
      spotGold.penumbra = 0.5
      scene.add(spotGold)

      const spotBlue = new THREE.SpotLight(0x6688ff, 600)
      spotBlue.position.set(-30, 20, -30)
      scene.add(spotBlue)

      const fill = new THREE.DirectionalLight(0xffeebb, 0.8)
      fill.position.set(0, 0, 50)
      scene.add(fill)
    }

    function setupPostProcessing() {
      const renderScene = new RenderPass(scene, camera)
      const bloomPass = new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        1.5,
        0.4,
        0.85
      )
      bloomPass.threshold = 0.7
      bloomPass.strength = 0.45
      bloomPass.radius = 0.4

      composer = new EffectComposer(renderer)
      composer.addPass(renderScene)
      composer.addPass(bloomPass)
    }

    function createTextures() {
      const canvas = document.createElement('canvas')
      canvas.width = 128
      canvas.height = 128
      const ctx = canvas.getContext('2d')
      ctx.fillStyle = '#ffffff'
      ctx.fillRect(0, 0, 128, 128)
      ctx.fillStyle = '#880000'
      ctx.beginPath()
      for (let i = -128; i < 256; i += 32) {
        ctx.moveTo(i, 0)
        ctx.lineTo(i + 32, 128)
        ctx.lineTo(i + 16, 128)
        ctx.lineTo(i - 16, 0)
      }
      ctx.fill()
      caneTexture = new THREE.CanvasTexture(canvas)
      caneTexture.wrapS = THREE.RepeatWrapping
      caneTexture.wrapT = THREE.RepeatWrapping
      caneTexture.repeat.set(3, 3)
    }

    class Particle {
      constructor(mesh, type, isDust = false) {
        this.mesh = mesh
        this.type = type
        this.isDust = isDust

        this.posTree = new THREE.Vector3()
        this.posScatter = new THREE.Vector3()
        this.baseScale = mesh.scale.x

        const speedMult = type === 'PHOTO' ? 0.3 : 2.0

        this.spinSpeed = new THREE.Vector3(
          (Math.random() - 0.5) * speedMult,
          (Math.random() - 0.5) * speedMult,
          (Math.random() - 0.5) * speedMult
        )

        this.calculatePositions()
      }

      calculatePositions() {
        const h = CONFIG.particles.treeHeight
        const halfH = h / 2
        let t = Math.random()
        t = Math.pow(t, 0.8)
        const y = t * h - halfH
        let rMax = CONFIG.particles.treeRadius * (1.0 - t)
        if (rMax < 0.5) rMax = 0.5
        const angle = t * 50 * Math.PI + Math.random() * Math.PI
        const r = rMax * (0.8 + Math.random() * 0.4)
        this.posTree.set(Math.cos(angle) * r, y, Math.sin(angle) * r)

        let rScatter = this.isDust
          ? 12 + Math.random() * 20
          : 8 + Math.random() * 12
        const theta = Math.random() * Math.PI * 2
        const phi = Math.acos(2 * Math.random() - 1)
        this.posScatter.set(
          rScatter * Math.sin(phi) * Math.cos(theta),
          rScatter * Math.sin(phi) * Math.sin(theta),
          rScatter * Math.cos(phi)
        )
      }

      update(dt, mode, focusTargetMesh) {
        let target = this.posTree

        if (mode === 'SCATTER') target = this.posScatter
        else if (mode === 'FOCUS') {
          if (this.mesh === focusTargetMesh) {
            const desiredWorldPos = new THREE.Vector3(0, 2, 35)
            const invMatrix = new THREE.Matrix4()
              .copy(mainGroup.matrixWorld)
              .invert()
            target = desiredWorldPos.applyMatrix4(invMatrix)
          } else {
            target = this.posScatter
          }
        }

        const lerpSpeed =
          mode === 'FOCUS' && this.mesh === focusTargetMesh ? 5.0 : 2.0
        this.mesh.position.lerp(target, lerpSpeed * dt)

        if (mode === 'SCATTER') {
          this.mesh.rotation.x += this.spinSpeed.x * dt
          this.mesh.rotation.y += this.spinSpeed.y * dt
          this.mesh.rotation.z += this.spinSpeed.z * dt
        } else if (mode === 'TREE') {
          this.mesh.rotation.x = THREE.MathUtils.lerp(
            this.mesh.rotation.x,
            0,
            dt
          )
          this.mesh.rotation.z = THREE.MathUtils.lerp(
            this.mesh.rotation.z,
            0,
            dt
          )
          this.mesh.rotation.y += 0.5 * dt
        }

        if (mode === 'FOCUS' && this.mesh === focusTargetMesh) {
          this.mesh.lookAt(camera.position)
        }

        let s = this.baseScale
        if (this.isDust) {
          s =
            this.baseScale *
            (0.8 + 0.4 * Math.sin(clock.elapsedTime * 4 + this.mesh.id))
          if (mode === 'TREE') s = 0
        } else if (mode === 'SCATTER' && this.type === 'PHOTO') {
          s = this.baseScale * 2.5
        } else if (mode === 'FOCUS') {
          if (this.mesh === focusTargetMesh) s = 4.5
          else s = this.baseScale * 0.8
        }

        this.mesh.scale.lerp(new THREE.Vector3(s, s, s), 4 * dt)
      }
    }

    function createParticles() {
      const sphereGeo = new THREE.SphereGeometry(0.5, 32, 32)
      const boxGeo = new THREE.BoxGeometry(0.55, 0.55, 0.55)
      const curve = new THREE.CatmullRomCurve3([
        new THREE.Vector3(0, -0.5, 0),
        new THREE.Vector3(0, 0.3, 0),
        new THREE.Vector3(0.1, 0.5, 0),
        new THREE.Vector3(0.3, 0.4, 0),
      ])
      const candyGeo = new THREE.TubeGeometry(curve, 16, 0.08, 8, false)

      const goldMat = new THREE.MeshStandardMaterial({
        color: CONFIG.colors.champagneGold,
        metalness: 1.0,
        roughness: 0.1,
        envMapIntensity: 2.0,
        emissive: 0x443300,
        emissiveIntensity: 0.3,
      })

      const greenMat = new THREE.MeshStandardMaterial({
        color: CONFIG.colors.deepGreen,
        metalness: 0.2,
        roughness: 0.8,
        emissive: 0x002200,
        emissiveIntensity: 0.2,
      })

      const redMat = new THREE.MeshPhysicalMaterial({
        color: CONFIG.colors.accentRed,
        metalness: 0.3,
        roughness: 0.2,
        clearcoat: 1.0,
        emissive: 0x330000,
      })

      const candyMat = new THREE.MeshStandardMaterial({
        map: caneTexture,
        roughness: 0.4,
      })

      for (let i = 0; i < CONFIG.particles.count; i++) {
        const rand = Math.random()
        let mesh, type

        if (rand < 0.4) {
          mesh = new THREE.Mesh(boxGeo, greenMat)
          type = 'BOX'
        } else if (rand < 0.7) {
          mesh = new THREE.Mesh(boxGeo, greenMat)
          type = 'GOLD_BOX'
        } else if (rand < 0.92) {
          mesh = new THREE.Mesh(sphereGeo, goldMat)
          type = 'GOLD_SPHERE'
        } else if (rand < 0.97) {
          mesh = new THREE.Mesh(sphereGeo, redMat)
          type = 'RED'
        } else {
          mesh = new THREE.Mesh(candyGeo, candyMat)
          type = 'CANE'
        }

        const s = 0.4 + Math.random() * 0.5
        mesh.scale.set(s, s, s)
        mesh.rotation.set(
          Math.random() * 6,
          Math.random() * 6,
          Math.random() * 6
        )

        mainGroup.add(mesh)
        particleSystem.push(new Particle(mesh, type, false))
      }

      const starGeo = new THREE.SphereGeometry(1, 32, 32)
      const starMat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        emissive: 0xf6abd5,
        emissiveIntensity: 1.0,
        metalness: 1.0,
        roughness: 0,
      })
      const star = new THREE.Mesh(starGeo, starMat)
      star.position.set(0, CONFIG.particles.treeHeight / 2 + 1.2, 0)
      mainGroup.add(star)

      mainGroup.add(photoMeshGroup)
    }

    function createDust() {
      const geo = new THREE.TetrahedronGeometry(0.08, 0)
      const mat = new THREE.MeshBasicMaterial({
        color: 0xffeebb,
        transparent: true,
        opacity: 0.8,
      })

      for (let i = 0; i < CONFIG.particles.dustCount; i++) {
        const mesh = new THREE.Mesh(geo, mat)
        mesh.scale.setScalar(0.5 + Math.random())
        mainGroup.add(mesh)
        particleSystem.push(new Particle(mesh, 'DUST', true))
      }
    }

    function createDefaultPhotos() {
      const canvas = document.createElement('canvas')
      canvas.width = 512
      canvas.height = 512
      const ctx = canvas.getContext('2d')
      ctx.fillStyle = '#050505'
      ctx.fillRect(0, 0, 512, 512)
      ctx.strokeStyle = '#f49ac4'
      ctx.lineWidth = 15
      ctx.strokeRect(20, 20, 472, 472)
      ctx.font = '500 60px Times New Roman'
      ctx.fillStyle = '#b6b6b6'
      ctx.textAlign = 'center'
      ctx.fillText('Âú£ËØû', 256, 230)
      ctx.fillText('Âø´‰πêÔºÅ', 256, 300)

      const tex = new THREE.CanvasTexture(canvas)
      tex.colorSpace = THREE.SRGBColorSpace
      addPhotoToScene(tex)
    }

    function addPhotoToScene(texture) {
      const frameGeo = new THREE.BoxGeometry(1.4, 1.4, 0.05)
      const frameMat = new THREE.MeshStandardMaterial({
        color: 0xfffafa,
        emissive: 0x000000,
        metalness: 1,
        roughness: 1,
      })
      const frame = new THREE.Mesh(frameGeo, frameMat)

      const photoGeo = new THREE.PlaneGeometry(1.2, 1.2)
      const photoMat = new THREE.MeshBasicMaterial({  color: 0xe0dbdb,emissive: 0x000000,map: texture })
      const photo = new THREE.Mesh(photoGeo, photoMat)
      photo.position.z = 0.04

      const group = new THREE.Group()
      group.add(frame)
      group.add(photo)

      const s = 0.8
      group.scale.set(s, s, s)

      photoMeshGroup.add(group)
      particleSystem.push(new Particle(group, 'PHOTO', false))
    }

    function handleImageUpload(e) {
      const files = e.target.files
      if (!files.length) return
      Array.from(files).forEach((f) => {
        const reader = new FileReader()
        reader.onload = (ev) => {
          new THREE.TextureLoader().load(ev.target.result, (t) => {
            t.colorSpace = THREE.SRGBColorSpace
            addPhotoToScene(t)
          })
        }
        reader.readAsDataURL(f)
      })
    }

    // ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè
    function setMode(mode) {
      STATE.mode = mode
      STATE.focusTarget = null
      
      if (mode === 'FOCUS') {
        const photos = particleSystem.filter(p => p.type === 'PHOTO')
        if (photos.length) {
          STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh
        } else {
          // Êó†ÁÖßÁâáÊó∂ÈªòËÆ§ÂõûÂà∞Ê†ëÂΩ¢
          STATE.mode = 'TREE'
          alert('ËØ∑ÂÖà‰∏ä‰º†ÁÖßÁâáÂÜç‰ΩøÁî®ËÅöÁÑ¶ÂäüËÉΩÔºÅ')
        }
      }
    }

    function setupEvents() {
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight
        camera.updateProjectionMatrix()
        renderer.setSize(window.innerWidth, window.innerHeight)
        composer.setSize(window.innerWidth, window.innerHeight)
      })
      
      // ‰∏ä‰º†ÁÖßÁâá
      document.getElementById('file-input').addEventListener('change', handleImageUpload)
      
      // ÁÆ°ÁêÜÁÖßÁâá
      document.getElementById('manage-photos-btn').addEventListener('click', showPhotoManager)
      document.getElementById('close-manager').addEventListener('click', hidePhotoManager)
      
      // ÊéßÂà∂ÊåâÈíÆ
      document.getElementById('tree-btn').addEventListener('click', () => setMode('TREE'))
      document.getElementById('scatter-btn').addEventListener('click', () => setMode('SCATTER'))
      document.getElementById('focus-btn').addEventListener('click', () => setMode('FOCUS'))
      
      // ÈîÆÁõòÊéßÂà∂
      window.addEventListener('keydown', (e) => {
        switch(e.key.toLowerCase()) {
          case 't':
            setMode('TREE')
            break
          case 's':
            setMode('SCATTER')
            break
          case 'f':
            setMode('FOCUS')
            break
          case 'h':
            const uiLayer = document.getElementById('ui-layer')
            uiLayer.classList.toggle('ui-hidden')
            break
        }
      })

      // ÊâãÊú∫Á´ØÔºöÊéßÂà∂ËØ¥ÊòéÈù¢Êùø3ÁßíÂêéËá™Âä®ÈöêËóèÔºà‰ªÖÈöêËóèÔºåÊó†ÈáçÊñ∞ÊòæÁ§∫ÈÄªËæëÔºâ
      const isMobile = window.innerWidth <= 768; // Âà§Êñ≠ÁßªÂä®Á´Ø
      const helpPanel = document.getElementById('help-panel');
      if (isMobile) {
        // 3ÁßíÂêéËá™Âä®ÈöêËóèÔºå‰∏î‰∏çÂÜçÈáçÊñ∞ÊòæÁ§∫
        setTimeout(() => {
          helpPanel.style.opacity = '0';
          helpPanel.style.pointerEvents = 'none'; // ÈöêËóèÂêéÁ¶ÅÊ≠¢ÁÇπÂáª
        }, 3000);
      }
    }

    function showPhotoManager() {
      updatePhotoGrid()
      document.getElementById('photo-manager').classList.remove('hidden')
    }

    function hidePhotoManager() {
      document.getElementById('photo-manager').classList.add('hidden')
    }

    function updatePhotoGrid() {
      const photoGrid = document.getElementById('photo-grid')
      photoGrid.innerHTML = ''
      
      const photoParticles = particleSystem.filter(p => p.type === 'PHOTO')
      
      photoParticles.forEach((particle, index) => {
        const photoItem = document.createElement('div')
        photoItem.className = 'photo-item'
        
        const photoMesh = particle.mesh.children[1]
        let imgUrl = ''
        
        if (photoMesh && photoMesh.material && photoMesh.material.map) {
          const texture = photoMesh.material.map
          if (texture.image && texture.image.currentSrc) {
            imgUrl = texture.image.currentSrc
          } else if (texture.image && texture.image.src) {
            imgUrl = texture.image.src
          }
        }
        
        photoItem.innerHTML = `
          <img src="${imgUrl}" alt="Photo ${index + 1}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\" viewBox=\"0 0 24 24\"><rect width=\"24\" height=\"24\" fill=\"%23222\"/><text x=\"12\" y=\"16\" font-family=\"Arial\" font-size=\"12\" fill=\"%23ddd\" text-anchor=\"middle\">No Image</text></svg>'">
          <div class="delete-btn" data-index="${index}">√ó</div>
        `
        photoGrid.appendChild(photoItem)
      })
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'))
          deletePhoto(index)
        })
      })
    }

    function deletePhoto(index) {
      const photoParticles = particleSystem.filter(p => p.type === 'PHOTO')
      
      if (index >= 0 && index < photoParticles.length) {
        const particleToDelete = photoParticles[index]
        
        if (particleToDelete.mesh && particleToDelete.mesh.parent) {
          particleToDelete.mesh.parent.remove(particleToDelete.mesh)
        }
        
        const particleIndex = particleSystem.indexOf(particleToDelete)
        if (particleIndex > -1) {
          particleSystem.splice(particleIndex, 1)
        }
        
        if (photoMeshGroup && particleToDelete.mesh) {
          photoMeshGroup.remove(particleToDelete.mesh)
        }
        
        updatePhotoGrid()
      }
    }

    function animate() {
      requestAnimationFrame(animate)
      const dt = clock.getDelta()
      
      controls.update()

      // ÊóãËΩ¨ÈÄªËæë
      if (STATE.mode === 'TREE') {
        mainGroup.rotation.y += 0.3 * dt
      } else if (STATE.mode === 'SCATTER') {
        mainGroup.rotation.y += 0.1 * dt
      }

      particleSystem.forEach((p) =>
        p.update(dt, STATE.mode, STATE.focusTarget)
      )
      composer.render()
    }

    // ÂêØÂä®ÂàùÂßãÂåñ
    init()
  </script>
</body>
</html>